name: Exitdir E2E Tests

on:
  pull_request:
    branches:
      - main

permissions: {}

defaults:
  run:
    shell: bash
    working-directory: ./src/github.com/chainguard-dev/exitdir


jobs:
  exitdir-tests:
    name: e2e tests
    runs-on: ubuntu-latest

    permissions:
      contents: read

    strategy:
      fail-fast: false # Keep running if one leg fails.
      matrix:
        k8s-version:
          - v1.33.x
          - v1.34.x

    env:
      GOPATH: ${{ github.workspace }}
      GO111MODULE: on
      GOFLAGS: -ldflags=-s -ldflags=-w
      KO_DOCKER_REPO: registry.local:5000/exitdir
      KOCACHE: ~/ko
      COSIGN_EXPERIMENTAL: true

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Check out our repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          path: ./src/github.com/chainguard-dev/exitdir
          persist-credentials: false

      - uses: chainguard-dev/actions/setup-mirror@fac81f8edade777ac0bedfa9f4a42591accab9c8 # v1.5.14

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.25'
          check-latest: true
          cache: false

      - uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
            ${{ env.KOCACHE }}
          key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.go-version }}-

      - uses: step-security/setup-ko@3b4d97844e4277c74a9d77ac00052d8ce96580d3 # v0.9.0
        with:
          version: v0.18.1

      - name: Setup Cluster
        uses: chainguard-dev/actions/setup-kind@fac81f8edade777ac0bedfa9f4a42591accab9c8 # v1.5.14
        id: kind
        with:
          k8s-version: ${{ matrix.k8s-version }}
          registry-authority: registry.local:5000
          cluster-suffix: cluster.local

      - name: Create sample job
        run: |
          ko apply -f - <<EOF
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: example
          spec:
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: leader
                    image: ko://chainguard.dev/exitdir/cmd/leader
                    env:
                      - name: EXIT_DIR
                        value: "/var/exitdir"
                    volumeMounts:
                      - name: exit-dir
                        mountPath: "/var/exitdir"
                  - name: follower
                    image: ko://chainguard.dev/exitdir/cmd/follower
                    env:
                      - name: EXIT_DIR
                        value: "/var/exitdir"
                    volumeMounts:
                      - name: exit-dir
                        mountPath: "/var/exitdir"
                volumes:
                  - name: exit-dir
                    emptyDir: {}
          EOF

      - name: Wait for job completion
        run: |
          kubectl wait --for=condition=complete --timeout=60s job/example
          kubectl logs job/example --all-containers

      - name: Collect diagnostics
        if: ${{ failure() }}
        uses: chainguard-dev/actions/kind-diag@fac81f8edade777ac0bedfa9f4a42591accab9c8 # v1.5.14
        with:
          artifact-name: logs.${{ matrix.k8s-version }}
